rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Only authenticated users can read/write their own user doc
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Wishes: authenticated users can read all; create only as themselves
    // Prevent manual editing of likeCount (only server/transaction should change it)
    match /wishes/{wishId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['text', 'userId', 'username', 'isAnonymous', 'x', 'y', 'likeCount', 'createdAt'])
        && request.resource.data.likeCount == 0;
      allow update: if request.auth != null
        // Only allow updating likeCount (e.g. via transaction); no other field changes by client
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount']);
      allow delete: if false;
    }

    // wishLikes: one like per user per wish
    match /wishLikes/{likeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['wishId', 'userId']);
      allow update, delete: if false;
    }
  }
}
